<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PikPak ä¸‹è¼‰åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .log-container { 
            background-color: #212529; 
            color: #4af626; 
            font-family: 'Consolas', monospace; 
            padding: 15px; 
            border-radius: 5px; 
            height: 500px; 
            overflow-y: auto; 
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .table-responsive { height: 500px; overflow-y: auto; }
        .progress { height: 20px; background-color: #e9ecef; }
        .status-active { color: #198754; font-weight: bold; }
        .status-waiting { color: #ffc107; font-weight: bold; }
        .status-paused { color: #6c757d; }
        .status-error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">ğŸš€ PikPak ä¸‹è¼‰åŠ©æ‰‹</h2>
        <span class="badge bg-secondary" id="connectionStatus">ç³»çµ±æ­£å¸¸</span>
    </div>
    
    <!-- æäº¤å€å¡Š -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">â• æ–°å¢ä¸‹è¼‰ä»»å‹™ (Add Magnet)</h5>
        </div>
        <div class="card-body">
            <form id="magnetForm">
                <div class="mb-3">
                    <textarea class="form-control" id="magnets" rows="3" placeholder="è«‹è²¼ä¸Šç£åŠ›é€£çµ (ä¸€è¡Œä¸€å€‹)..."></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div id="resultMessage"></div>
                    <button type="submit" class="btn btn-primary px-4">ğŸš€ æäº¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é‡è©¦å¡ä½ä»»å‹™å€å¡Š -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ”„ é‡è©¦å¡ä½çš„ä»»å‹™ (Retry Stuck)</h5>
            <span class="badge bg-dark" id="stuckCount">0 å€‹å¡ä½</span>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label small text-muted">é€²åº¦é–¾å€¼ (åªé‡è©¦ >= æ­¤é€²åº¦çš„ä»»å‹™)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="minProgress" value="90" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">é¸é …</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="deleteCloud" checked>
                        <label class="form-check-label small" for="deleteCloud">åŒæ™‚åˆªé™¤é›²ç«¯ä¸å®Œæ•´æª”æ¡ˆ</label>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <label class="form-label d-block">&nbsp;</label>
                    <button class="btn btn-outline-secondary me-2" onclick="checkStuck()">ğŸ” æª¢æŸ¥</button>
                    <button class="btn btn-warning" onclick="retryStuck()">ğŸ”„ é‡è©¦å…¨éƒ¨</button>
                </div>
            </div>
            <div id="stuckList" class="mt-3" style="display: none;">
                <hr>
                <div class="small text-muted mb-2">å¡ä½çš„ä»»å‹™ï¼š</div>
                <ul id="stuckTaskList" class="list-group list-group-flush small"></ul>
            </div>
            <div id="retryResult" class="mt-2"></div>
        </div>
    </div>

    <!-- ç›£æ§å€å¡Š -->
    <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" id="monitorTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab">
                        â¬‡ï¸ ä¸‹è¼‰ç‹€æ…‹ (Aria2)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log" type="button" role="tab">
                        ğŸ“ ç³»çµ±æ—¥èªŒ (Logs)
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="tab-content" id="monitorTabsContent">
                
                <!-- Tab 1: ä¸‹è¼‰åˆ—è¡¨ -->
                <div class="tab-pane fade show active" id="download" role="tabpanel">
                    <div class="table-responsive p-3 bg-white">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 40%">æª”æ¡ˆåç¨±</th>
                                    <th style="width: 15%">ç‹€æ…‹</th>
                                    <th style="width: 20%">é€²åº¦</th>
                                    <th style="width: 15%">é€Ÿåº¦/å¤§å°</th>
                                    <th style="width: 10%">å‰©é¤˜æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- JS å‹•æ…‹æ’å…¥ -->
                                <tr><td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: æ—¥èªŒ -->
                <div class="tab-pane fade" id="log" role="tabpanel">
                    <div id="logArea" class="log-container rounded-0 rounded-bottom">ç­‰å¾…æ—¥èªŒ...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å·¥å…·å‡½æ•¸ ---
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function formatTime(seconds) {
        if (!isFinite(seconds) || seconds > 86400 * 30) return '--:--'; // Over 30 days
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return [
            h > 0 ? h : null,
            m > 9 ? m : (h > 0 ? '0' + m : m),
            s > 9 ? s : '0' + s
        ].filter(a => a !== null).join(':');
    }

    function getStatusClass(status) {
        switch(status) {
            case 'active': return 'status-active';
            case 'waiting': return 'status-waiting';
            case 'paused': return 'status-paused';
            case 'error': return 'status-error';
            case 'cloud_downloading': return 'status-active text-primary';
            case 'cloud_complete': return 'status-active text-success';
            case 'cloud_error': return 'status-error';
            default: return '';
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'active': return 'ä¸‹è¼‰ä¸­ (Aria2)';
            case 'waiting': return 'ç­‰å¾…ä¸­ (Aria2)';
            case 'paused': return 'æš«åœ (Aria2)';
            case 'error': return 'éŒ¯èª¤ (Aria2)';
            case 'complete': return 'å®Œæˆ (Aria2)';
            case 'cloud_downloading': return 'â˜ï¸ é›¢ç·šä¸‹è¼‰ä¸­';
            case 'cloud_complete': return 'â˜ï¸ é›¢ç·šå®Œæˆ';
            case 'cloud_error': return 'â˜ï¸ é›¢ç·šéŒ¯èª¤';
            default: return status;
        }
    }

    // --- ä¸»é‚è¼¯ ---
    
    // æäº¤ç£åŠ›é€£çµ
    document.getElementById('magnetForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const magnets = document.getElementById('magnets').value;
        const btn = this.querySelector('button');
        const msgDiv = document.getElementById('resultMessage');
        
        if (!magnets.trim()) return;

        btn.disabled = true;
        btn.innerHTML = 'è™•ç†ä¸­...';
        msgDiv.innerHTML = '';

        try {
            const response = await fetch('/api/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({magnets: magnets})
            });
            const data = await response.json();
            
            if (data.status === 'ok') {
                msgDiv.innerHTML = `<span class="text-success fw-bold">âœ… å·²æˆåŠŸæ·»åŠ  ${data.count} å€‹ä»»å‹™ï¼</span>`;
                document.getElementById('magnets').value = '';
                // åˆ‡æ›åˆ°æ—¥èªŒé çœ‹è™•ç†é€²åº¦
                // var triggerEl = document.querySelector('#log-tab')
                // bootstrap.Tab.getOrCreateInstance(triggerEl).show()
                fetchLogs();
            } else {
                msgDiv.innerHTML = `<span class="text-danger fw-bold">âŒ éŒ¯èª¤: ${data.message}</span>`;
            }
        } catch (error) {
            msgDiv.innerHTML = `<span class="text-danger fw-bold">âŒ è«‹æ±‚å¤±æ•—: ${error}</span>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ æäº¤';
            setTimeout(() => msgDiv.innerHTML = '', 5000);
        }
    });

    // ç²å–æ—¥èªŒ
    async function fetchLogs() {
        // åªæœ‰ç•¶ Tab æ˜¯ active çš„æ™‚å€™æ‰æ›´æ–°ï¼Œç¯€çœè³‡æº
        if (!document.getElementById('log').classList.contains('active')) return;

        try {
            const response = await fetch('/api/logs');
            const data = await response.json();
            const logArea = document.getElementById('logArea');
            // åªåœ¨æœ‰è®Šå‹•æ™‚æ›´æ–°DOM? ç°¡å–®èµ·è¦‹ç›´æ¥æ›¿æ›
            logArea.innerHTML = data.logs.join('<br>');
            logArea.scrollTop = logArea.scrollHeight;
        } catch (e) {
            console.error("Log fetch error", e);
        }
    }

    // ç²å–ä»»å‹™åˆ—è¡¨
    async function fetchTasks() {
        // åªæœ‰ç•¶ Tab æ˜¯ active çš„æ™‚å€™æ‰æ›´æ–°
        if (!document.getElementById('download').classList.contains('active')) return;

        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            const tbody = document.getElementById('taskTableBody');
            
            if (data.tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">ç›®å‰æ²’æœ‰æ­£åœ¨é€²è¡Œçš„ä¸‹è¼‰ä»»å‹™</td></tr>';
                return;
            }

            const html = data.tasks.map(task => {
                const percent = task.progress || (task.total > 0 ? (task.completed / task.total * 100).toFixed(1) : 0);
                const eta = task.speed > 0 ? formatTime((task.total - task.completed) / task.speed) : (task.status === 'cloud_downloading' ? 'é›²ç«¯è™•ç†ä¸­' : '--');
                const statusClass = getStatusClass(task.status);
                
                let typeBadge = '';
                if (task.type === 'pikpak') {
                    typeBadge = '<span class="badge bg-info me-1">PikPak</span>';
                } else {
                    typeBadge = '<span class="badge bg-success me-1">Aria2</span>';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                ${typeBadge}
                                <div class="fw-bold text-truncate" style="max-width: 250px;" title="${task.name}">${task.name}</div>
                            </div>
                            ${task.error ? `<div class="text-danger small ms-1">${task.error}</div>` : ''}
                        </td>
                        <td class="${statusClass} small">${getStatusText(task.status)}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                    <div class="progress-bar ${task.status === 'active' || task.status === 'cloud_downloading' ? 'progress-bar-striped progress-bar-animated' : ''}" 
                                         role="progressbar" 
                                         style="width: ${percent}%"></div>
                                </div>
                                <span class="small text-muted">${percent}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold">${formatBytes(task.speed)}/s</div>
                            <div class="small text-muted">${formatBytes(task.total)}</div>
                        </td>
                        <td class="text-muted font-monospace small">${eta}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
            document.getElementById('connectionStatus').className = 'badge bg-success';
            document.getElementById('connectionStatus').innerText = 'é€£ç·šæ­£å¸¸';

        } catch (e) {
            console.error("Stats fetch error", e);
            document.getElementById('connectionStatus').className = 'badge bg-danger';
            document.getElementById('connectionStatus').innerText = 'é€£ç·šå¤±æ•—';
        }
    }

    // --- é‡è©¦å¡ä½ä»»å‹™ç›¸é—œ ---
    
    // æª¢æŸ¥å¡ä½çš„ä»»å‹™
    async function checkStuck() {
        const minProgress = document.getElementById('minProgress').value || 90;
        const countBadge = document.getElementById('stuckCount');
        const listDiv = document.getElementById('stuckList');
        const taskList = document.getElementById('stuckTaskList');
        
        countBadge.innerText = 'æª¢æŸ¥ä¸­...';
        
        try {
            const response = await fetch(`/api/stuck?min_progress=${minProgress}`);
            const data = await response.json();
            
            countBadge.innerText = `${data.count} å€‹å¡ä½`;
            countBadge.className = data.count > 0 ? 'badge bg-danger' : 'badge bg-success';
            
            if (data.count > 0) {
                listDiv.style.display = 'block';
                taskList.innerHTML = data.tasks.map(t => 
                    `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        <span class="text-truncate" style="max-width: 70%;" title="${t.name}">${t.name}</span>
                        <span>
                            <span class="badge bg-secondary me-1">${t.account.split('@')[0]}</span>
                            <span class="badge bg-warning text-dark">${t.progress}%</span>
                        </span>
                    </li>`
                ).join('');
            } else {
                listDiv.style.display = 'none';
            }
        } catch (e) {
            console.error("Check stuck error", e);
            countBadge.innerText = 'æª¢æŸ¥å¤±æ•—';
            countBadge.className = 'badge bg-danger';
        }
    }
    
    // é‡è©¦å¡ä½çš„ä»»å‹™
    async function retryStuck() {
        const minProgress = parseInt(document.getElementById('minProgress').value) || 90;
        const deleteCloud = document.getElementById('deleteCloud').checked;
        const resultDiv = document.getElementById('retryResult');
        
        if (!confirm(`ç¢ºå®šè¦é‡è©¦æ‰€æœ‰é€²åº¦ >= ${minProgress}% çš„å¡ä½ä»»å‹™å—ï¼Ÿ\n\né€™æœƒåˆªé™¤é›²ç«¯ä¸å®Œæ•´çš„æª”æ¡ˆä¸¦é‡æ–°é–‹å§‹é›¢ç·šä¸‹è¼‰ã€‚`)) {
            return;
        }
        
        resultDiv.innerHTML = '<span class="text-muted">è™•ç†ä¸­...</span>';
        
        try {
            const response = await fetch('/api/retry', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    min_progress: minProgress,
                    delete_cloud: deleteCloud
                })
            });
            const data = await response.json();
            
            if (data.success + data.fail === 0) {
                resultDiv.innerHTML = '<span class="text-success">âœ… æ²’æœ‰æ‰¾åˆ°å¡ä½çš„ä»»å‹™</span>';
            } else {
                resultDiv.innerHTML = `
                    <span class="text-success">âœ… æˆåŠŸ: ${data.success}</span>
                    ${data.fail > 0 ? `<span class="text-danger ms-2">âŒ å¤±æ•—: ${data.fail}</span>` : ''}
                `;
            }
            
            // åˆ·æ–°åˆ—è¡¨
            setTimeout(checkStuck, 1000);
            setTimeout(() => resultDiv.innerHTML = '', 5000);
            
        } catch (e) {
            console.error("Retry error", e);
            resultDiv.innerHTML = '<span class="text-danger">âŒ é‡è©¦å¤±æ•—</span>';
        }
    }
    
    // å®šæ™‚ä»»å‹™
    setInterval(fetchLogs, 3000);
    setInterval(fetchTasks, 2000);
    setInterval(checkStuck, 30000); // æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡å¡ä½çš„ä»»å‹™
    
    // åˆå§‹åŒ–
    fetchLogs();
    fetchTasks();
    checkStuck();
</script>
</body>
</html>